<!DOCTYPE html>
<html lang="en">
<head>
  <title>Anglo American</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="shortcut icon" href="../img/logo.png">
  <link rel="icon" type="image/png" href="../img/logo.png">
  <meta name="description" content="Interactive 3D Web application made with Verge3D. Immerse yourself in amazing graphics experience offered by state-of-the-art WebGL and HTML5 technologies.">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Verge3D Web Interactive">
  <meta name="twitter:description" content="Interactive 3D Web application made with Verge3D. Immerse yourself in amazing graphics experience offered by state-of-the-art WebGL and HTML5 technologies.">
  <meta name="twitter:image:src" content="https://cdn.soft8soft.com/images/player_socials.jpg">
  <meta property="og:title" content="Verge3D Web Interactive">
  <meta property="og:description" content="Interactive 3D Web application made with Verge3D. Immerse yourself in amazing graphics experience offered by state-of-the-art WebGL and HTML5 technologies.">
  <meta property="og:image" content="https://cdn.soft8soft.com/images/player_socials.jpg">
  <meta property="og:type" content="website">

  <meta name="generator" content="Verge3D 4.8.0">

  <link rel="apple-touch-icon" sizes="180x180" href="media/apple-touch-icon.png">

  <link rel="manifest" href="media/manifest.json">
  <link rel="mask-icon" href="media/safari-pinned-tab.svg" color="#0048a5">
  <meta name="theme-color" content="#ffffff">

  <script src="v3d.js"></script>
  <script src="METSO.js"></script>

  <link rel="stylesheet" type="text/css" href="METSO.css">

  <style>
    /* Fullscreen loader overlay */
    #v3d-loader{
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ffffff; /* fondo blanco */
      z-index: 99999;
      /* solo animamos opacity para el fade-out */
      transition: opacity 0.8s cubic-bezier(.2,.8,.2,1);
      opacity: 1;
      visibility: visible;
      pointer-events: all;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Inner wrapper to allow centering and responsive sizing */
    .v3d-loader-inner{
      text-align: center;
      will-change: transform;
    }

    /* The word container with letters as inline blocks */
    .v3d-loader-word{
      display: inline-flex;
      gap: 6px;
      align-items: baseline;
      justify-content: center;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      font-weight: 700;
      color: #031794; /* Color final de las letras (azul) */
      letter-spacing: 1px;
      /* size responsive: min 28px, max 96px */
      font-size: clamp(28px, 6vw, 96px);
    }

    /*
      Variables:
        --paint-duration : duración de la animación de pintado por letra
        --i              : índice de la letra para el stagger (retraso)
    */
    .v3d-loader-letter{
      display: inline-block;
      transform-origin: center bottom;
      /* Parámetros para la nueva animación de pintado */
      --paint-duration: 0.25s; /* Duración que tarda en pintarse cada letra */
      
      /* **INICIALMENTE LAS LETRAS SON BLANCAS** (el mismo color que el fondo) */
      color: #ffffff;

      animation-duration: var(--paint-duration);
      animation-name: v3d-paint;
      animation-timing-function: ease-out;
      animation-iteration-count: 1; /* Solo una vez por letra */
      animation-fill-mode: forwards; /* Mantiene el estado final (azul) */
      /* stagger por letra */
      animation-delay: calc(var(--i, 0) * 0.1s); /* Ajusta el 0.1s para el retraso entre letras */
      will-change: color;
      /* avoid text selection while loading */
      user-select: none;
      -webkit-user-select: none;
    }
    
    /* **NUEVOS** keyframes para la animación de pintado */
    @keyframes v3d-paint{
      0%   { color: #ffffff; } /* Comienza en color blanco (fondo) */
      100% { color: #031794; } /* Termina en el color azul definido en .v3d-loader-word */
    }

    /* --- INICIO ESTILOS AÑADIDOS --- */

    /* Estilos para el porcentaje */
    .v3d-loader-percentage {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      font-weight: 500; /* Un poco más ligero que el título */
      font-size: clamp(18px, 3vw, 32px); /* Más pequeño que el título */
      color: #031794; /* Mismo azul que las letras */
      margin-top: 25px; /* Espacio superior */
      letter-spacing: 1px;
      
      /* Empieza oculto y aparece con un fundido */
      opacity: 0;
      animation: v3d-fade-in 0.5s ease-out 0.5s forwards; /* Aparece después de 0.5s */
      will-change: opacity, content;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Keyframes para el fundido de entrada del porcentaje */
    @keyframes v3d-fade-in {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    /* --- FIN ESTILOS AÑADIDOS --- */

    /* Clase para forzar pausa inmediata de las letras (ya no es tan relevante, pero se mantiene la lógica de JS) */
    .v3d-loader-paused .v3d-loader-letter {
      /* La animación de color ya terminó por su fill-mode, pero no hace daño mantenerlo */
      animation-play-state: paused !important;
    }

    /* Clase que activa el fade-out (solo opacidad; visibility se ajusta desde JS tras la transición) */
    .v3d-loader-fade {
      opacity: 0;
      pointer-events: none;
    }

    /* Small accessibility improvement on reduced-motion preference (quitamos la animación si no la prefieren) */
    @media (prefers-reduced-motion: reduce) {
      .v3d-loader-letter {
        /* Si se reduce la moción, mostramos el color final inmediatamente */
        animation: none;
        color: #031794 !important;
      }
      .v3d-loader-percentage {
        /* Sin animación de entrada */
        animation: none;
        opacity: 1;
      }
    }
  </style>
  </head>

<body>

  <div id="v3d-loader" aria-hidden="true">
    <div class="v3d-loader-inner">
      <img src="../img/logo.png" style="width: 150px; margin: 30px 30px -35px 0px;">
      <div class="v3d-loader-word" role="img" aria-label="AngloAmerican">
        <span class="v3d-loader-letter" style="--i:0">A</span>
        <span class="v3d-loader-letter" style="--i:1">n</span>
        <span class="v3d-loader-letter" style="--i:2">g</span>
        <span class="v3d-loader-letter" style="--i:3">l</span>
        <span class="v3d-loader-letter" style="--i:4">o</span>
        <span class="v3d-loader-letter" style="--i:5">A</span>
        <span class="v3d-loader-letter" style="--i:6">m</span>
        <span class="v3d-loader-letter" style="--i:7">e</span>
        <span class="v3d-loader-letter" style="--i:8">r</span>
        <span class="v3d-loader-letter" style="--i:9">i</span>
        <span class="v3d-loader-letter" style="--i:10">c</span>
        <span class="v3d-loader-letter" style="--i:11">a</span>
        <span class="v3d-loader-letter" style="--i:12">n</span>
      </div>
      
      <div class="v3d-loader-percentage" id="v3d-loader-percentage">0%</div>
      </div>
  </div>
  <div id="v3d-container">
    <div id="fullscreen-button" class="fullscreen-button fullscreen-open" title="Toggle fullscreen mode"></div>
  </div>

  <script>
    (function(){
      var MAX_TRIES = 200; // hasta ~20s de espera
      var tries = 0;
      var pollInterval = 100;
      var installed = false;
      var loaderHidden = false;

      // --- INICIO CÓDIGO AÑADIDO ---
      var percEl = document.getElementById('v3d-loader-percentage');
      var currentPercentage = 0;
      var percTimerId; // Usaremos setTimeout

      function updatePercentage() {
        // Si el loader ya se está ocultando o el elemento no existe, paramos.
        if (loaderHidden || !percEl) {
          if (percTimerId) clearTimeout(percTimerId);
          return;
        }

        var increment;
        var nextInterval;

        if (currentPercentage < 80) {
          // Fase 1: Rápido hasta 80%
          increment = Math.max(1, Math.floor(Math.random() * 3)); // Incremento aleatorio (1 o 2)
          nextInterval = 30 + Math.random() * 20; // Intervalo rápido
        } else if (currentPercentage < 99) {
          // Fase 2: Lento de 80% a 99%
          increment = 1; // Incremento de 1
          nextInterval = 250 + Math.random() * 200; // Intervalo lento
        } else {
          // Fase 3: Quedarse en 99%
          currentPercentage = 99;
          percEl.textContent = currentPercentage + '%';
          // No hacemos nada más, ya no re-programamos el timeout
          return; 
        }
        
        currentPercentage = Math.min(currentPercentage + increment, 99); // Aseguramos no pasar de 99
        percEl.textContent = currentPercentage + '%';
        
        // Re-programar el próximo update
        percTimerId = setTimeout(updatePercentage, nextInterval);
      }

      // Iniciar la animación del porcentaje si el elemento existe
      if (percEl) {
         percTimerId = setTimeout(updatePercentage, 30); // Inicia el ciclo
      }
      // --- FIN CÓDIGO AÑADIDO ---


      function hideLoaderOnce(){
        // --- INICIO CÓDIGO MODIFICADO ---
        // Detener la animación del porcentaje y forzar 100%
        if (percTimerId) {
          clearTimeout(percTimerId);
          percTimerId = null;
        }
        if (percEl && !loaderHidden) { // Solo poner 100% la primera vez
           percEl.textContent = '100%';
        }
        // --- FIN CÓDIGO MODIFICADO ---

        if (loaderHidden) return;
        loaderHidden = true;

        var loader = document.getElementById('v3d-loader');
        if (!loader) return;

        // Pausar las letras antes del fade para evitar "saltos" extra
        loader.classList.add('v3d-loader-paused');

        // Forzar reflow
        void loader.offsetWidth;

        // Añadir clase que inicia fade
        loader.classList.add('v3d-loader-fade');

        // Cuando termine la transición de opacidad, eliminar/ocultar definitivamente
        var onTransitionEnd = function(e){
          if (e.propertyName === 'opacity') {
            try {
              loader.removeEventListener('transitionend', onTransitionEnd);
            } catch(_) {}
            // esconder completamente y remover del flujo para que no bloquee nada
            loader.setAttribute('aria-hidden', 'true');
            loader.style.visibility = 'hidden';
            // colocamos z-index bajo para asegurar que no cubra nada
            loader.style.zIndex = '-1';
            // remover del DOM para limpiar (opcional)
            if (loader.parentNode) {
              try { loader.parentNode.removeChild(loader); } catch(_) {}
            }
          }
        };
        loader.addEventListener('transitionend', onTransitionEnd);

        // En caso de que transitionend no dispare (navegadores raros), forzamos una limpieza a los 1s
        setTimeout(function(){
          var l = document.getElementById('v3d-loader');
          if (l) {
            l.setAttribute('aria-hidden', 'true');
            l.style.visibility = 'hidden';
            l.style.zIndex = '-1';
            if (l.parentNode) try { l.parentNode.removeChild(l); } catch(_) {}
          }
        }, 1200);
      }

      function wrapExistingFunction(proc){
        try {
          var existing = proc["inicio"];
          if (typeof existing === 'function' && !existing.__v3d_wrapped) {
            var orig = existing;
            var wrapper = function(){
              try { orig.apply(this, arguments); } catch(e){ console.error("Error en inicio (orig):", e); }
              // ocultar loader una vez se ejecute inicio
              hideLoaderOnce();
            };
            wrapper.__v3d_wrapped = true;
            // reasignar la función envuelta
            try { proc["inicio"] = wrapper; } catch(e){
              // si no se puede reasignar (propiedad no configurable), intentar definirla
              Object.defineProperty(proc, "inicio", {
                configurable: true,
                enumerable: true,
                writable: true,
                value: wrapper
              });
            }
            return true;
          }
        } catch(e){}
        return false;
      }

      function installInterceptorOnFutureAssignment(proc){
        // Si la propiedad ya existe como accesible pero no es función, o no está aún definida,
        // interceptamos la asignación futura usando defineProperty
        try {
          var descriptor = Object.getOwnPropertyDescriptor(proc, "inicio");
          if (descriptor && descriptor.configurable === false) {
            // no configurable => intentar envolver si es función ya (handled earlier)
            return;
          }

          var currentValue = proc["inicio"];
          var saved = currentValue;

          Object.defineProperty(proc, "inicio", {
            configurable: true,
            enumerable: true,
            get: function(){
              return saved;
            },
            set: function(fn){
              if (typeof fn === 'function') {
                // crear wrapper que llama la función asignada y oculta loader
                var wrapped = function(){
                  try { fn.apply(this, arguments); } catch(e){ console.error("Error en inicio (set):", e); }
                  hideLoaderOnce();
                };
                wrapped.__v3d_wrapped = true;
                saved = wrapped;
              } else {
                saved = fn;
              }
            }
          });
          return true;
        } catch(e){
          return false;
        }
      }

      function tryInstall(){
        tries++;
        if (!window.v3d || !v3d.puzzles || !v3d.puzzles.procedures) {
          if (tries > MAX_TRIES) {
            clearInterval(intervalId);
          }
          return;
        }
        var proc = v3d.puzzles.procedures;

        // 1) si ya existe una función, envolverla
        var wrappedNow = wrapExistingFunction(proc);

        // 2) interceptar futuras asignaciones (por si el autor asigna inicio más tarde)
        var intercepted = installInterceptorOnFutureAssignment(proc);

        if (wrappedNow || intercepted) {
          installed = true;
          clearInterval(intervalId);
        } else {
          // si no pudo instalar (propiedad no configurable o error), stop después de intentos
          if (tries > MAX_TRIES) clearInterval(intervalId);
        }
      }

      // Si v3d ya está listo, intentamos instalar inmediatamente; si no, poll
      var intervalId = setInterval(tryInstall, pollInterval);
      // Intento inmediato
      tryInstall();

    })();
  </script>
  </body>

</html>